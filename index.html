<script>
  // üîê Insert your Google Gemini browser API key
  const USER_API_KEY = "AIzaSyCzbKIxl1kag2hqRb5bPGqxUp_GlhwqKmY"; // <-- paste real key here

  // Model and API
  const MODEL_NAME = "gemini-2.5-flash";
  const API_URL = `https://generativelanguage.googleapis.com/v1/models/${MODEL_NAME}:generateContent`;

  // Elements
  const engineerInput  = document.getElementById('engineerInput');
  const summaryOutput  = document.getElementById('summaryOutput');
  const generateButton = document.getElementById('generateButton');
  const buttonText     = document.getElementById('buttonText');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const charCount      = document.getElementById('charCount');
  const messageBox     = document.getElementById('messageBox');
  const errorMessage   = document.getElementById('errorMessage');
  const copyMessage    = document.getElementById('copyMessage');

  // Character counter
  function updateCharCount() {
    const currentLength = summaryOutput.value.length;
    charCount.textContent = `Characters: ${currentLength} / 470 (Includes headers and spaces)`;
    if (currentLength > 470) {
      charCount.classList.remove('text-gray-500');
      charCount.classList.add('text-red-500');
    } else {
      charCount.classList.add('text-gray-500');
      charCount.classList.remove('text-red-500');
    }
  }
  summaryOutput.addEventListener('input', updateCharCount);
  window.addEventListener('DOMContentLoaded', updateCharCount);

  function hideMessage() { messageBox.classList.add('hidden'); }
  function showMessage(message) { errorMessage.textContent = message; messageBox.classList.remove('hidden'); }
  function clearAll() { engineerInput.value = ""; summaryOutput.value = ""; hideMessage(); updateCharCount(); engineerInput.focus(); }
  function testClick() { showMessage("Button wiring OK ‚Äî now paste notes and click Generate."); setTimeout(() => hideMessage(), 2000); }

  // Inline system prompt (we are not using systemInstruction)
  const systemPrompt =
`You are a professional technical summarization engine for client invoicing. Your task is to analyze detailed engineering reports (mechanical, electrical, or hydraulic) and extract the Symptoms, Cause, and Solution.

You MUST format the output into exactly three separate paragraphs, each preceded by a bold heading and ending with a period. Use the following structure precisely, with two newline characters (\\n\\n) between each section:

**Symptoms**
[A professional, concise summary of the symptom(s).]

**Cause**
[A professional, concise summary of the cause identified.]

**Solution**
[A professional, concise summary of the remedy applied.]

The total generated text, including the bold headers, paragraphs, and all newlines/spaces, MUST NOT exceed 470 characters in length. This is a strict, hard limit. Prioritize extreme brevity while maintaining professionalism.`;

  // Build payload WITHOUT systemInstruction (inline prompt)
  function buildPayloadInlineSystem(userText) {
    const combined = `${systemPrompt}\n\n[Engineer Notes]\n${userText}`;
    return {
      contents: [
        { role: "user", parts: [{ text: combined }] }
      ],
      generationConfig: {
        temperature: 0.2,
        maxOutputTokens: 300
      }
    };
  }

  // Friendly key guard: ensure key-like length
  function ensureKey() {
    if (typeof USER_API_KEY !== "string" || USER_API_KEY.trim().length < 30) {
      showMessage("Error: API Key is missing or too short. Paste a valid browser key in USER_API_KEY.");
      return false;
    }
    return true;
  }

  async function callGemini(payload) {
    const url = `${API_URL}?key=${USER_API_KEY}`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (response.status === 401) {
      throw new Error("API Key Invalid. Please check the key and referrer restrictions.");
    }
    if (!response.ok) {
      const errorBody = await response.json().catch(() => ({ error: { message: 'Non-JSON error response.' } }));
      throw new Error(`API Request failed with status ${response.status}: ${errorBody.error?.message || 'Unknown API error'}`);
    }
    return await response.json();
  }

  async function generateSummary() {
    hideMessage();
    const userQuery = engineerInput.value.trim();

    if (!ensureKey()) return;
    if (!userQuery) {
      showMessage("Please paste the engineer's technical notes into the input box before generating the summary.");
      return;
    }

    // UI state
    generateButton.disabled = true;
    buttonText.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    summaryOutput.value = "Generating summary...";
    updateCharCount();

    try {
      const payload = buildPayloadInlineSystem(userQuery);
      const result = await callGemini(payload);

      const candidate = result.candidates?.[0];
      if (candidate?.content?.parts?.[0]?.text) {
        let text = candidate.content.parts[0].text.trim();
        if (text.length > 470) {
          const cut = text.lastIndexOf('.', 470);
          text = text.slice(0, cut > 0 ? cut + 1 : 470);
        }
        summaryOutput.value = text;
      } else {
        if (result.error?.message) throw new Error(`API Error: ${result.error.message}`);
        throw new Error("Received an unexpected or empty response from the API.");
      }
    } catch (error) {
      console.error("Summary Generation Error:", error);
      const displayMessage = error.message.includes("API Key Invalid")
        ? error.message
        : `Failed to generate summary. Please check your network connection and API key. Details: ${error.message}`;
      showMessage(displayMessage);
      summaryOutput.value = "Error generating summary.";
    } finally {
      generateButton.disabled = false;
      buttonText.classList.remove('hidden');
      loadingSpinner.classList.add('hidden');
      updateCharCount();
    }
  }

  // Expose for onclick
  window.generateSummary = generateSummary;
  window.copyToClipboard = function copyToClipboard() {
    const textToCopy = summaryOutput.value;
    if (textToCopy && textToCopy !== "Generating summary..." && textToCopy !== "Error generating summary.") {
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(textToCopy).then(() => {
          copyMessage.classList.remove('opacity-0');
          setTimeout(() => copyMessage.classList.add('opacity-0'), 2000);
        }).catch(err => console.error('Clipboard write failed: ', err));
      } else {
        try {
          summaryOutput.select();
          document.execCommand('copy');
          copyMessage.classList.remove('opacity-0');
          setTimeout(() => copyMessage.classList.add('opacity-0'), 2000);
        } catch (err) {
          console.error('Could not copy text: ', err);
        }
      }
    } else {
      showMessage("Nothing to copy or summary is still generating/in error state.");
    }
  };
  window.testClick = testClick;
  window.clearAll = clearAll;
</script>
``
